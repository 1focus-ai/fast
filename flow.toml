[[tasks]]
name = "setup"
description = "Install dependencies with Bun (fallback to npm if missing)."
command = '''
bash <<'BASH'
set -euo pipefail
echo "Checking prerequisites"
if command -v bun >/dev/null 2>&1; then
  echo "Installing deps (bun install)"
  bun install >/dev/null 2>&1 || {
    echo "Warning: Bun failed to install dependencies."
  }
else
  if ! command -v npm >/dev/null 2>&1; then
    echo "npm CLI not found in PATH."
    echo "Install Bun (https://bun.sh) or Node.js (https://nodejs.org)."
    exit 1
  fi
  echo "Installing deps (npm install)"
  npm install >/dev/null 2>&1 || {
    echo "Warning: npm failed to install dependencies."
  }
fi
echo "✔️ you are setup"
BASH
'''

[[tasks]]
name = "build"
description = "Produce a standalone CLI binary via Bun."
command = '''
bash <<'BASH'
set -euo pipefail
if ! command -v bun >/dev/null 2>&1; then
  echo "Bun runtime 'bun' not found in PATH."
  echo "Install it from https://bun.sh before building."
  exit 1
fi
repo_root="$PWD"
dist_dir="$repo_root/dist"
tmp_root="${TMPDIR:-/tmp}"
tmp_dir="$(mktemp -d "$tmp_root/fast-build-XXXXXX")"
trap 'rm -rf "$tmp_dir"' EXIT
bun build "$repo_root/src/main.ts" --compile --outfile "$tmp_dir/fast"
mkdir -p "$dist_dir"
mv "$tmp_dir/fast" "$dist_dir/fast"
chmod 755 "$dist_dir/fast"
echo "Built CLI at $dist_dir/fast"
BASH
'''

[[tasks]]
name = "deploy"
description = "Build the CLI and install it to ~/bin (optionally add to PATH)."
command = '''
bash <<'BASH'
set -euo pipefail
repo_root="$PWD"
dist_dir="$repo_root/dist"
command_name="fast"

if [ ! -f "$dist_dir/$command_name" ]; then
  echo "Built binary $dist_dir/$command_name missing; run the build task first."
  exit 1
fi

install_dir="$HOME/bin"
mkdir -p "$install_dir"
install_path="$install_dir/$command_name"
rm -f "$install_path"
cp "$dist_dir/$command_name" "$install_path"
chmod 755 "$install_path"
echo "Installed CLI to $install_path"

help_snapshot="$("$install_path" --help 2>&1 || true)"
notes=$(printf 'Running `%s` without arguments opens an fzf-powered command palette.\n\nFor `%s commit`, export `OPENAI_API_KEY` so the CLI can talk to OpenAI. Telemetry via 1focus requires AXIOM_TOKEN and AXIOM_DATASET.' "$command_name" "$command_name")
{
  echo "# $command_name"
  echo
  printf '```\n%s --help\n' "$command_name"
  printf '%s\n' "$help_snapshot"
  printf '```\n\n'
  echo '## Notes'
  echo
  printf '%s\n' "$notes"
} > "$repo_root/readme.install.md"

case ":${PATH:-}:" in
  *:"$install_dir":*)
    echo "$install_dir already present in PATH"
    ;;
  *)
    shell_name="$(basename "${SHELL:-}")"
    marker="# >>> ${command_name} initialize >>>"
    end_marker="# <<< ${command_name} initialize <<<"
    target=""
    snippet=""
    case "$shell_name" in
      fish)
        target="$HOME/.config/fish/conf.d/${command_name}.fish"
        snippet='fish_add_path $HOME/bin'
        ;;
      zsh)
        target="$HOME/.zshrc"
        snippet='export PATH="$HOME/bin:$PATH"'
        ;;
      bash)
        target="$HOME/.bashrc"
        snippet='export PATH="$HOME/bin:$PATH"'
        ;;
      *)
        echo "$install_dir is not on PATH. Add it to your shell configuration manually."
        target=""
        ;;
    esac

    if [ -n "$target" ] && [ -f "$target" ] && grep -F "$marker" "$target" >/dev/null 2>&1; then
      echo "$install_dir already configured via $target"
    elif [ -n "$target" ]; then
      printf 'Add %s to PATH in %s? [y/N]: ' "$install_dir" "${target:-manual}"
      read -r reply || reply=""
      case "$reply" in
        [yY]*)
          mkdir -p "$(dirname "$target")"
          if [ "$shell_name" = "fish" ]; then
            {
              echo "$marker"
              echo "$snippet"
              echo "$end_marker"
            } > "$target"
          else
            {
              printf '\n%s\n' "$marker"
              printf '%s\n' "$snippet"
              printf '%s\n' "$end_marker"
            } >> "$target"
          fi
          echo "Updated $target. Restart your shell or source the file to use $command_name."
          ;;
        *)
          echo "Skipped PATH update. Add $install_dir to PATH manually if needed."
          ;;
      esac
    fi
    ;;
esac

if command -v fish >/dev/null 2>&1; then
  fish_conf_dir="$HOME/.config/fish/conf.d"
  mkdir -p "$fish_conf_dir"
  fish_binding_file="$fish_conf_dir/${command_name}-dot.fish"
  {
    printf '%s\n' "# Auto-generated by deploy task for $command_name."
    printf '%s\n' "function . --description \"Use '.' as a shortcut for $command_name or source files\""
    printf '  %s\n' "set -l __f_cli \"$install_path\""
    printf '  %s\n' "set -l __dist_cli \"$dist_dir/$command_name\""
    printf '  %s\n' "if not test -x \"\$__f_cli\""
    printf '    %s\n' "set __f_cli \"\$__dist_cli\""
    printf '  %s\n' "end"
    printf '\n'
    printf '  %s\n' "if test (count \$argv) -gt 0"
    printf '    %s\n' "set -l __target \"\$argv[1]\""
    printf '    %s\n' "if test -e \"\$__target\""
    printf '      %s\n' "builtin source \$argv"
    printf '      %s\n' "return \$status"
    printf '    %s\n' "end"
    printf '    %s\n' "if string match -rq '^[./~]' \"\$__target\""
    printf '      %s\n' "builtin source \$argv"
    printf '      %s\n' "return \$status"
    printf '    %s\n' "end"
    printf '  %s\n' "end"
    printf '\n'
    printf '  %s\n' "if not test -x \"\$__f_cli\""
    printf '    %s\n' "echo \"$command_name binary missing; run the deploy task again.\" >&2"
    printf '    %s\n' "return 1"
    printf '  %s\n' "end"
    printf '\n'
    printf '  %s\n' "command \"\$__f_cli\" \$argv"
    printf '%s\n' "end"
  } > "$fish_binding_file"
  echo "Configured fish binding '.' -> $command_name at $fish_binding_file."
  echo "Reload fish (or run 'source $fish_binding_file') to enable it."
else
  echo "fish shell not found; skipping '.' binding."
fi
BASH
'''

[dependencies]
"github.com/1focus-ai/fast" = "fast"
